# Generated by Django 3.2.6 on 2021-09-15 12:34

from django.db import migrations, models
import django.db.models.deletion


def update_instrument_field(apps, schema_editor):
    DataLocation = apps.get_model('dataset', 'DataLocation')
    for row in DataLocation.objects.all():
        row.instrument = row.dataset.instrument
        row.save()


def update_metadata_content_type(apps, schema_editor):
    DataLocation = apps.get_model('dataset', 'DataLocation')
    for row in DataLocation.objects.all():
        row.metadata_content_type = row.dataset.metadata_content_type
        row.save()


class Migration(migrations.Migration):

    dependencies = [
        ('contenttypes', '0002_remove_content_type_name'),
        ('dataset', '0002_alter_datalocation_unique_together'),
    ]

    operations = [
        migrations.AddField(
            model_name='datalocation',
            name='instrument',
            field=models.ForeignKey(default=None, null=True, on_delete=django.db.models.deletion.CASCADE, to='dataset.instrument'),
        ),
        migrations.RunPython(update_instrument_field),
        migrations.AddField(
            model_name='datalocation',
            name='metadata_content_type',
            field=models.ForeignKey(blank=True, help_text='The model for this dataset metadata',
                                    limit_choices_to=models.Q(('app_label', 'metadata'),
                                                              models.Q(('model', 'tag'),_negated=True)),
                                    null=True,
                                    on_delete=django.db.models.deletion.SET_NULL, to='contenttypes.contenttype'),
        ),
        migrations.RunPython(update_metadata_content_type),
        migrations.AlterField(
            model_name='datalocation',
            name='file_name',
            field=models.CharField(help_text='Full file name including extension (.fits)', max_length=255, unique=True),
        ),
        migrations.AlterUniqueTogether(
            name='datalocation',
            unique_together=set(),
        ),
        migrations.RemoveField(
            model_name='datalocation',
            name='dataset',
        ),
        migrations.DeleteModel(
            name='Dataset',
        ),
    ]
